% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Description of Numerical Model
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\chapter{Numerical Model}
\label{model_chapter}

It's called Tuna! 

% -----------------------------------------------------------------------------
% -----------------------------------------------------------------------------
% -----------------------------------------------------------------------------
\section{Coordinate System}

We use lowercase $x$, $y$, and $z$ to indicate field-aligned coordinates. The
unit vector \zhat is aligned with the dipole field (pointing outward in the
northern hemisphere and inward in the southern hemisphere), while \xhat and
\yhat are perpendicular to the dipole field; \xhat lies in the meridinal plane,
and \yhat in the azimuthal direction.

But we don't actually do calculations in $x$, $y$, $z$. 

It's convenient to align our grid to the zeroth-order field. This allows us to
decouple the parallel and perpendicular components of the permittivity and
conductivity tendors. Traditional dipole coordinates are written as (using $r$,
$\theta$, and $\phi$ in the usual spherical sense): 
\begin{align}
  \mu & = -\frac{\sin^2 \theta}{r} & \phi & = \phi & \nu & = \frac{\cos \theta}{r^2}
\end{align}

Notably, $\mu$ is constant over a given field line -- it can also be written as
$\frac{-1}{L}$, where $L$ is the McIlwain parameter. This makes it easy to
specify inner and outer boudaries. On the other hand, the natural choice for
boundaries in $\nu$ are the ionospheric current sheets. These sheets fall at 
(more or less) constant altitude, but not constant $\nu$. 

Following the example of [Lysak 2004], $\nu$ can be rescaled to come to a
constant value at the ionospheric boundary. 
\begin{align}
  u^1 & = - \frac{R_I}{r} \sin^2 \theta & u^2 & = \phi & u^3 & = \frac{R_I^2}{r^2} \frac{\cos \theta}{\cos \theta_0}
\end{align}


\begin{align}
  \label{def_jacobian}
  D &= ... \\
    &= \sqrt{ \frac{ g_{33} }{ g^{11} g^{22} } }
\end{align}




Here, $\theta_0$ is a field line's invariant colatitude; that is, the
colatitude at which it intersects the ionosphere. 

Note that $u^1$ is constant over each field line, $u^3 = 1$ where each field
line intersects the ionosphere in the northern hemisphere, and $u^3 = -1$ where
each field line intersects the ionosphere in the southern hemisphere. 

The tradeoff is that these coordinates are not orthogonal. As a result, a
distinction must be made between covariant and contravariant coordinates. The
distinction is discussed in detail in [differential geometry appendix].  

% -----------------------------------------------------------------------------
% -----------------------------------------------------------------------------
% -----------------------------------------------------------------------------
\section{Two and a Half Dimensions}

Tuna's grid takes a slice through the meridinal plane. Either dayside or nightside. 

We don't explicitly resolve the azimuthal direction. Instead, we suppose that everything valies as $\exp(i m \phi)$. 

This is appropriate because we're looking at phenomena that are azimuthally localized. 

It's perhaps better to think of the azimuthal direction in terms of a wavelength, rather than a modenumber. We don't actually care about periodicity. 
Fields are all stored as complex numbers. The real component is at the slice. The imaginary component is offset from the slice by a phase of $\frac{\pi}{2}$. 

% -----------------------------------------------------------------------------
% -----------------------------------------------------------------------------
% -----------------------------------------------------------------------------
\section{Maxwell's Equations}
  \label{model_equations_section}

First, let's consider Faraday's Law. 

\begin{align}
  \ddt \vec{B} & = - \curl{E}
\end{align}

Written in generalized coordinates, we can write this as:

\begin{align}
  \ddt B^i & = -\frac{ \varepsilon^{ijk} }{D} \partial_j E_k
\end{align}

Where D is the determinant of the Jacobian matrix, as defined in \cref{def_jacobian}.

Using the metric tensor to eliminate contravariant coordinates, we get: 

\begin{align}
  \ddt B_i & = -\frac{g_{ij}}{D} \varepsilon^{jkl} \partial_k E_l
\end{align}

Or...

\begin{align}
  \ddt B_1 & = -\frac{ g_{11} }{D} \left( \partial_2 E_3 - \partial_3 E_2 \right)
               -\frac{ g_{13} }{D} \left( \partial_1 E_2 - \partial_2 E_1 \right) \\
  \ddt B_2 & = -\frac{ g_{22} }{D} \left( \partial_3 E_1 - \partial_1 E_3 \right) \\
  \ddt B_3 & = -\frac{ g_{31} }{D} \left( \partial_2 E_3 - \partial_3 E_2 \right)
               -\frac{ g_{33} }{D} \left( \partial_1 E_2 - \partial_2 E_1 \right)
\end{align}

\Ampere's law is a bit more complicated. Let's break it into parallel and perpendicular components. 

\begin{align}
  \epsilon_\bot \ddt \vec{E}_\bot &= \frac{1}{\mu_0} \left( \curl{B} \right)_\bot - \vec{J}_\bot \\
  \epsilon_\parallel \ddt E_\parallel &= \frac{1}{\mu_0} \left( \curl{B} \right)_\parallel - J_\parallel
\end{align}

For the perpendicular component, the current ($J$) can be eliminated using Kirchhoff's formulation of Ohm's Law, $\vec{J} = \tensor{\sigma} \cdot \vec{E}$. 

\begin{align}
  \epsilon_\bot \ddt \vec{E}_\bot &= \frac{1}{\mu_0} \left( \curl{B} \right)_\bot - \tensor{\sigma}_\bot \cdot \vec{E}_\bot
\end{align}

As noted earlier, \xhat and \yhat are the perpendicular directions to the zeroth-order magnetic field. Note also that we can rewrite this expression using the \Alfven speed, $\frac{1}{\mu_0 \epsilon_\bot} = v^2$. 

\begin{align}
  \ddt E_x &= v^2 \left( \curl{B} \right)_x - \frac{\sigma_P}{\epsilon_\bot} E_x + \frac{\sigma_H}{\epsilon_\bot} E_y \\
  \ddt E_y &= v^2 \left( \curl{B} \right)_y - \frac{\sigma_H}{\epsilon_\bot} E_x - \frac{\sigma_P}{\epsilon_\bot} E_y
\end{align}

The Hall conductivity couples the two perpendicular electric field components. They can be disentangled by a change of variables, $E_\pm \equiv E_x \pm i E_y$. Components of $\curl{B}$ are defined analogously. Then, 

\begin{align}
  \ddt E_\pm &= v^2 \left( \curl{B} \right)_\pm + \left( \frac{\sigma_P}{\epsilon_\bot} \pm i \frac{\sigma_H}{\epsilon_\bot} \right) E_\pm
\end{align}

This can be solved with integrating factors. Setting $\alpha \equiv \frac{\sigma_P}{\epsilon_\bot} \pm i \frac{\sigma_H}{\epsilon_\bot}$...

\begin{align}
 \lr{ \ddt + \alpha } E_\pm &= v^2 \lr{ \curl{B} }_\pm
\end{align}

...

\begin{align}
  \exp \lr{ \alpha t } \lr{ \ddt + \alpha } E_\pm 
  &= v^2 \exp \lr{ \alpha t } \lr{ \curl{B} }_\pm 
\end{align}

...

\begin{align}
  \ddt \lr{ E_\pm \exp \lr{ \alpha t } } &= v^2 \lr{ \curl{B} }_\pm \exp \lr{ \alpha t }
\end{align}

...

\begin{align}
  \displaystyle\int^{\dt}_0 dt \ddt \lr{ E_\pm \lr{t} \exp \lr{ \alpha t } }
  &= \displaystyle\int_0^{\dt} dt v^2 \lr{ \curl{B} \lr{t} }_\pm \exp \lr{\alpha t}
\end{align}

...

%\begin{align}
%  E_\pm (\dt) \exp \left( \frac{\sigma_P}{\epsilon_\bot} \dt \pm i \frac{\sigma_H}{\epsilon_\bot} \dt \right) - E_\pm (0) &= \dt v^2 \left( \curl{B} ( {\scriptstyle\frac{\dt}{2}} ) \right)_\pm \exp \left( \frac{\sigma_P}{\epsilon_\bot} {\scriptstyle\frac{\dt}{2} \pm i \frac{\sigma_H}{\epsilon_\bot} \frac{\dt}{2}} \right)
%\end{align}





We use lowercase $x$, $y$, and $z$ to indicate field-aligned coordinates. The
unit vector \zhat is aligned with the dipole field (pointing outward in the
northern hemisphere and inward in the southern hemisphere), while \xhat and
\yhat are perpendicular to the dipole field; \xhat lies in the meridinal plane,
and \yhat in the azimuthal direction.





We begin with \Ampere's Law, Faraday's Law, and Ohm's Law; respectively: 
\begin{align}
  \tensor{\epsilon} \cdot \frac{\partial}{\partial t} \underline{E} & = \frac{1}{\mu_0} \nabla \times \underline{B} - \underline{j} \\
  \frac{\partial}{\partial t} \underline{B} & = - \nabla \times \underline{E} \\
  \underline{j} & = \underline{ \underline{\sigma} } \cdot \underline{E}
\end{align}

Note that we're looking at perturbations from the zeroth-order dipole field. 

Use Ohm's law to eliminate $j$. 

Write in terms of contravariant components. 

Solve using integrating factors. 
\begin{align}
  \delta B^i & = -\frac{\delta t}{J} \varepsilon^{ijk} \partial_j E_k \\
  ... & = ...
\end{align}

A characteristic time step for Tuna is $10^{-5} s$. As a result, the exponent $- \frac{\sigma_0 \delta t}{\epsilon_0}$ is, at most, in the thousands. Numbers that small can't be stored numerically, so $E_3$ is uniformly zero. 

% -----------------------------------------------------------------------------
% -----------------------------------------------------------------------------
% -----------------------------------------------------------------------------
\subsection{Electron Inertial Contributions}

Above, we took the common (simplified) version of Ohm's Law. The generalized form is:
\begin{align}
  \underline{E} +
  \underline{U} \times \underline{B} & = 
  \eta \underline{j} +
  \frac{m}{n e^2} \Big[
    \frac{\partial}{\partial t} \underline{j} +
    \nabla \cdot \big( \underline{j} \underline{U} +
    \underline{U} \underline{j} +
    \frac{ \underline{j} \underline{j} }{n e} \big) 
  \Big] +
  \frac{1}{n e} \underline{j} \times \underline{B} -
  \frac{1}{n e} \nabla \cdot \underline{ \underline{P_e} }
\end{align}

As before, we ignore the convective terms (since we're looking at a cold plasma), as well as the nonlinear terms (since Tuna is a linear code). 

Note: we should probably justify that these terms are small, not juse that we don't feel like computing them. 

Note: also talk about why we're only keeping the parallel contribution. It's the only one that's linear, AND it should be by far the largest. 

After pulling the conductivity tensor out of the denominator, we are left with the same form as before, but with an added term representing electron intertia:
\begin{align}
  j_3 & =
  \sigma_0 E_3 -
  \frac{m}{n e^2} \frac{\partial}{\partial t} j_3
\end{align}

Or, equally: 
\begin{align}
  \frac{\partial}{\partial t} j_3 & = 
  \frac{n e^2 \sigma_0}{m} E_3 - 
  \frac{n e^2}{m} j_3
\end{align}

We can no longer solve for $E_3$ using integrating factors. Now we solve for it directly, and solve for $j_3$. 

... (make sure these factors are lined up correctly). 

Then we have 
\begin{align}
  j_3(\delta t) & = 
  j_3(0) \exp \big( -\frac{n e^2}{m \sigma_0} \delta t \big) +  
  \frac{\delta t}{2} \frac{n e^2}{m} E_3 
    \big( \frac{\delta t}{2} \big) \exp \big( -\frac{n e^2}{m \sigma_0} \frac{\delta t}{2} \big)
\end{align}

There's a problem. For stability, we need $\delta t < \frac{1}{ \omega_{p e} }$. We're off by a lot. 

The trick is to decrease $\epsilon_\parallel$, in effect lowering the speed of light. This is the Boris approximation (is that precisely true?). It's used in lots of codes, and discussed in ...

Note also that this means we compute $j$ when we compute $B$. It's offset from the electric fields by half of a time step. 

A researcher in Sweden (?) came up with the same trick as Bob, and called it "anisotropic vacuum." Show that a low speed of light -- even if it's lower than the \Alfven speed -- is allowed. Effects go as the square of $\omega/\omega_p$. 

Look for, in Bob's papers, mentions of anomalous resistivity / Landau damping. 

% -----------------------------------------------------------------------------
% -----------------------------------------------------------------------------
% -----------------------------------------------------------------------------
\section{Driving}

Compressional driving can't penetrate at high $m$. 

Pc4 constrains location and frequency. 

Ring current determines frequency and power. 

% -----------------------------------------------------------------------------
% -----------------------------------------------------------------------------
% -----------------------------------------------------------------------------
\section{Boundary Conditions}

Dirichlet means we specify the value at the boundary. 

Neumann means we specify the derivative at the boundary. 

We use Dirichlet for the E field and Neumann for the B field. 

It's implemented through the differentiation and interpolation helper
functions. 

\subsection{Stability}

We definitely have to be consistent about which fields are neumann and which are
dirichlet. 

\subsection{Parity Considerations}

Wigglies. 

Table listing odds and evens. 

Note that we really have four grids which are only weakly coupled. Rather than
using numerical diffusion to couple them (which is also a thing that people
do?), we only use one of them. $B_3$ is computed only on even i and even k. If
we need it anywhere else, we interpolate it. 

This means that BCs could be thought of as just off the grid. If a field doesn't
try to use the value just off the grid to differentiate or interpolate a value
at the edge, the boundary condition is not used. 

% -----------------------------------------------------------------------------
% -----------------------------------------------------------------------------
% -----------------------------------------------------------------------------
\section{Coupling to the Atmosphere}

Laplace's Equation. 

Comparison to spherical harmonics. 

Ionospheric jump condition. 

% -----------------------------------------------------------------------------
% -----------------------------------------------------------------------------
% -----------------------------------------------------------------------------
\section{Parallel Electric Fields}

Or, field aligned currents. 

Boris approximation for stability. LFM, BATRUS use this? 


% -----------------------------------------------------------------------------
% -----------------------------------------------------------------------------
% -----------------------------------------------------------------------------
\section{Discussion of Model Parameters}

Ring current power spectrum. Find more storms to look at! 

Some drive parameters don't really matter. Exact drive position, for example, in r and $\theta$? Boundary conditions (at least for the phenomena we care about)?

We use SYMH to estimate the appropriate level of current for driving. We use some storms:

June 1-3, 2013

March 17, 2015

June 22-23, 2015

And there were some good ones in October and November 2012. 

Looking at SYMH. Fourier series out to a period of about a minute. The power spectrum (judging from June 1-3 2013) gives you ~$10^{-2} (T/minutes)$. We can hand-wave a mapping from SYMH to the ring current. 
\begin{align}
  B & = \frac{\mu_0 I}{2 R}
\end{align}

With $B \sim \SI{2}{\nano\tesla}$, $R \sim \SI{4}{\RE}$, $A \sim \SI{1}{\RE\squared}$, we end up with $j \sim \SI{e-4}{\micro\ampere/\meter\squared}$. 

% -----------------------------------------------------------------------------
% -----------------------------------------------------------------------------
% -----------------------------------------------------------------------------
\section{Optimization of Model}

Extensive precomputation of coefficients. 

Reduced memory demand? Not clear if this is still true when we're tracking C and F. 

OpenMP. 

MPI benchmarks. C++ vs Fortran. Can we get some plots for this? Even just 2 ranks, neglecting the atmosphere. 













